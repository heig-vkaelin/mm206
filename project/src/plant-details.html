<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Valentin Kaelin" />
    <meta name="author" content="Francesco Monti" />
    <meta name="description" content="MM206 - Project" />
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/pages/plant-details.css" />
    <title>Plant details - Helseflora</title>
  </head>
  <body>
    <header class="website-header">
      <a class="website-nav" href="index.html">
        <img class="website-logo" src="images/logo.png" alt="Helseflora logo" />
        <h2 class="website-title">Helseflora</h2>
      </a>
      <a href="cart.html" id="cart" class="btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
          <path
            d="M24 0C10.7 0 0 10.7 0 24S10.7 48 24 48H76.1l60.3 316.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24-10.7 24-24s-10.7-24-24-24H179.9l-9.1-48h317c14.3 0 26.9-9.5 30.8-23.3l54-192C578.3 52.3 563 32 541.8 32H122l-2.4-12.5C117.4 8.2 107.5 0 96 0H24zM176 512c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm336-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48z"
          />
        </svg>
      </a>
    </header>

    <div class="spin"></div>

    <main id="plant-container" hidden>
      <div id="plant-details">
        <!-- Image -->
        <div id="plant-image">
          <img />
          <p id="discount">-30%</p>
        </div>

        <!-- Product info -->
        <div id="plant-info">
          <h1></h1>
          <h3></h3>
          <div>
            <p class="price"></p>
          </div>

          <div id="plant-reviews"><div></div></div>

          <div id="plant-description"><p></p></div>

          <form id="cart-form">
            <div>
              <button id="add-to-cart" type="submit">Add to cart</button>
              <p id="plant-stock"></p>
            </div>
          </form>

          <section class="details">
            <div>
              <div>
                <h3>
                  <!-- Expand/collapse question button -->
                  <button id="additional-details-button" type="button">
                    <!-- Open: "text-indigo-600", Closed: "text-gray-900" -->
                    <span class="details-title">Additional Details</span>
                    <span class="details-buttons">
                      <svg
                        class="visible"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        aria-hidden="true"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                      </svg>

                      <svg
                        class=""
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        aria-hidden="true"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" />
                      </svg>
                    </span>
                  </button>
                </h3>
                <div class="prose" id="additional-details" hidden></div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </body>

  <script type="module">
    import { fetchAPI, ENDPOINTS } from './services/api.js';

    const container = document.querySelector('#plant-container');
    const spinner = document.querySelector('.spin');
    const additionalDetailsButton = document.querySelector('#additional-details-button');
    const additionalDetails = document.querySelector('#additional-details');
    const cartForm = document.querySelector('#cart-form');

    additionalDetailsButton.addEventListener('click', () => {
      additionalDetailsButton.children[1].children[0].classList.toggle('visible');
      additionalDetailsButton.children[1].children[1].classList.toggle('visible');
      additionalDetailsButton.children[0].classList.toggle('title-open');
      additionalDetails.toggleAttribute('hidden');
    });

    cartForm.addEventListener('submit', (event) => event.preventDefault());

    async function fetchPlantDetails() {
      try {
        const { data: plants } = await fetchAPI(ENDPOINTS.PLANTS);
        if (plants.length === 1) {
          displayPlant(plants[0]);
        } else {
          container.innerHTML = '<h1 class="no-results">Plant not found</h1>';
        }
      } catch (error) {
        container.innerHTML = '<h1 class="no-results">Plant id not valid</h1>';
      }

      spinner.hidden = true;
      container.hidden = false;
    }

    function displayPlant(plant) {
      const plantImage = document.querySelector('#plant-image').children[0];
      const plantInfo = document.querySelector('#plant-info');
      const plantName = plantInfo.children[0];
      const plantCategory = plantInfo.children[1];
      const plantPrice = plantInfo.children[2].children[0];
      const plantReviews = document.querySelector('#plant-reviews');
      const plantDescription = document.querySelector('#plant-description').children[0];
      const cartButton = document.querySelector('#add-to-cart');
      const plantStock = document.querySelector('#plant-stock');
      const plantAdditionalDetails = document.querySelector('#additional-details');
      const discount = document.querySelector('#discount');

      plantImage.src = plant.image;
      plantName.textContent = plant.name;
      plantCategory.textContent = plant.category_name;
      plantPrice.textContent = `kr ${plant.price},-`;

      // plant.rating = 4;

      if (plant.rating !== null && plant.rating > 0 && plant.rating <= 5) {
        let ratingHtml = `<svg  class="star" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z"
                  clip-rule="evenodd"/>
          </svg>`.repeat(5);
        plantReviews.children[0].innerHTML = ratingHtml;

        for (let r = 0; r < plant.rating; r++) {
          plantReviews.children[0].children[r].classList.add('full-star');
        }
      } else {
        plantReviews.children[0].textContent = 'No reviews yet';
      }

      if (plant.stock > 0) {
        plantStock.textContent = `${plant.stock} remaining`;
      } else {
        plantStock.classList.add('out-of-stock');
        plantStock.innerHTML = `Out of stock<br/>Estimate delivery time: ${new Date(plant.expected_shipped).toLocaleDateString()}`;
      }

      plantDescription.textContent = plant.description;
      plantAdditionalDetails.innerHTML = `
      <ul>
        <li>Normal height: ${plant.height} cm</li>

        <li>
          Recommended fertilizer mix: ${plant.nitrogen} % nitrogen, ${plant.potassium} % potassium,
          ${plant.phosphor} % phosphorus. Should not be planted if the temperature during the day is below
          ${plant.min_temp_day} degrees, or the temperature at night is below ${plant.min_temp_night}
          degrees.
        </li>
      </ul>
      `;

      if (plant.discount > 0) {
        discount.textContent = `- ${plant.discount}%`;
      } else {
        discount.style.display = 'none';
      }

      const addToCart = document.querySelector('#add-to-cart');
      addToCart.addEventListener('click', () => addToCartHandler(plant));
    }

    function addToCartHandler(plant) {
      console.log('Add to cart: ', plant);
      const cart = JSON.parse(localStorage.getItem('cart')) ?? {};

      if (cart[plant.id]) {
        cart[plant.id].quantity++;
      } else {
        cart[plant.id] = {
          id: plant.id,
          name: plant.name,
          price: plant.price,
          quantity: 1,
        };
      }

      localStorage.setItem('cart', JSON.stringify(cart));
    }

    fetchPlantDetails();
  </script>
</html>
